{% extends "base.html" %}

{% block title %}Buat Nota - Nota Perusahaan{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Receipt Form -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Form Nota Baru
                </h5>
            </div>
            <div class="card-body">
                <form id="receiptForm">
                    <!-- Company Selection -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="companySelect" class="form-label">
                                <i class="fas fa-building me-1"></i>Perusahaan
                            </label>
                            <select class="form-select" id="companySelect" required>
                                <option value="">Pilih Perusahaan</option>
                                {% for company in companies %}
                                <option value="{{ company.code }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="receiptNumber" class="form-label">
                                <i class="fas fa-hashtag me-1"></i>Nomor Nota
                            </label>
                            <input type="text" class="form-control" id="receiptNumber" readonly>
                        </div>
                    </div>

                    <!-- Date and Recipient -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="receiptDate" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Tanggal
                            </label>
                            <input type="date" class="form-control" id="receiptDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="recipient" class="form-label">
                                <i class="fas fa-user me-1"></i>Kepada Yth
                            </label>
                            <input type="text" class="form-control" id="recipient" placeholder="Nama Penerima" required>
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="address" class="form-label">
                                <i class="fas fa-map-marker-alt me-1"></i>Alamat Pembeli
                            </label>
                            <textarea class="form-control" id="address" rows="2" placeholder="Alamat lengkap pembeli" required></textarea>
                        </div>
                    </div>

                    <!-- Tax Fields (for CH company) -->
                    <div class="row mb-3" id="taxFields" style="display: none;">
                        <div class="col-md-6">
                            <label for="dpp" class="form-label">
                                <i class="fas fa-calculator me-1"></i>DPP
                            </label>
                            <input type="number" class="form-control" id="dpp" step="0.01" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="ppn" class="form-label">
                                <i class="fas fa-percentage me-1"></i>PPN (11%)
                            </label>
                            <input type="number" class="form-control" id="ppn" step="0.01" readonly>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="mb-3">
                        <h6 class="text-primary">
                            <i class="fas fa-list me-1"></i>Daftar Barang
                        </h6>
                        
                        <!-- Add Item Form -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-2">
                                <input type="text" class="form-control" id="itemQuantity" placeholder="Qty">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="itemType" placeholder="Jenis Barang">
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control" id="itemSize" placeholder="Ukuran" disabled>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control" id="itemColor" placeholder="Warna">
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control" id="itemUnitPrice" placeholder="Harga Satuan" step="0.01">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-success btn-sm" id="addItemBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Items Table -->
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered" id="itemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Qty</th>
                                        <th>Jenis Barang</th>
                                        <th>Ukuran</th>
                                        <th>Warna</th>
                                        <th>Harga Satuan</th>
                                        <th>Total</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Payment Fields (for non-CH companies) -->
                    <div class="row mb-3" id="discountFields" style="display: none;">
                        <div class="col-md-4">
                            <label for="discount" class="form-label">
                                <i class="fas fa-tags me-1"></i>Diskon (%/Rp)
                            </label>
                            <input type="text" class="form-control" id="discount" placeholder="10% atau 50000">
                        </div>
                        <div class="col-md-4">
                            <label for="dp" class="form-label">
                                <i class="fas fa-hand-holding-usd me-1"></i>DP
                            </label>
                            <input type="number" class="form-control" id="dp" step="0.01" placeholder="0">
                        </div>
                        <div class="col-md-4">
                            <label for="remainingPayment" class="form-label">
                                <i class="fas fa-credit-card me-1"></i>Sisa Perlu Bayar
                            </label>
                            <input type="number" class="form-control" id="remainingPayment" step="0.01" readonly>
                        </div>
                    </div>

                    <!-- Total Section -->
                    <div class="row mb-3">
                        <div class="col-md-6 offset-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row mb-2">
                                        <div class="col-6">Total Sebelum Potongan:</div>
                                        <div class="col-6 text-end" id="totalBeforeDiscount">Rp 0</div>
                                    </div>
                                    <div class="row mb-2" id="discountRow" style="display: none;">
                                        <div class="col-6">Diskon:</div>
                                        <div class="col-6 text-end" id="discountAmount">Rp 0</div>
                                    </div>
                                    <div class="row mb-2" id="totalAfterDiscountRow" style="display: none;">
                                        <div class="col-6">Total Setelah Diskon:</div>
                                        <div class="col-6 text-end" id="totalAfterDiscount">Rp 0</div>
                                    </div>
                                    <div class="row mb-2" id="dpRow" style="display: none;">
                                        <div class="col-6">DP:</div>
                                        <div class="col-6 text-end" id="dpAmount">Rp 0</div>
                                    </div>
                                    <div class="row mb-2" id="remainingRow" style="display: none;">
                                        <div class="col-6">Sisa Perlu Bayar:</div>
                                        <div class="col-6 text-end" id="remainingAmount">Rp 0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Simpan Nota
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearFormBtn">
                            <i class="fas fa-eraser me-1"></i>Clear Form
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-4">
        <!-- Database Stats -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-database me-1"></i>Database Status
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 id="receiptsCount" class="text-primary">0</h4>
                        <small class="text-muted">Nota</small>
                    </div>
                    <div class="col-6">
                        <h4 id="itemsCount" class="text-success">0</h4>
                        <small class="text-muted">Item</small>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress">
                        <div class="progress-bar" id="dbProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted">Database usage</small>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0">
                    <i class="fas fa-bolt me-1"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <button class="btn btn-outline-primary w-100 mb-2" id="exportBtn">
                    <i class="fas fa-download me-1"></i>Export & Reset Database
                </button>
                <button class="btn btn-outline-success w-100 mb-2" id="viewHistoryBtn">
                    <i class="fas fa-history me-1"></i>Lihat Riwayat
                </button>
                <button class="btn btn-outline-info w-100" id="setupBtn">
                    <i class="fas fa-cog me-1"></i>Setup Database
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-1"></i>Berhasil!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Nota berhasil disimpan ke database!</p>
                <p class="text-muted small">Data akan otomatis sinkron ke semua perangkat.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-1"></i>Error!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage">Terjadi kesalahan saat menyimpan nota.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}
